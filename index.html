<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Printer Index</title>
    <style>
      :root { --border:#e5e5e5; --fg:#171717; --muted:#666; --bg:#fafafa; --ring:#c7d2fe; }
      *{ box-sizing:border-box; }
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; color:var(--fg); background:var(--bg); }
      header{ position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:#fffccccc; border-bottom:1px solid var(--border); z-index:10; }
      .container{ max-width:1200px; margin:0 auto; padding:12px 16px; }
      .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      .spacer{ flex:1; }
      input[type="text"], input[type="number"], select, textarea{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:14px; background:#fff; }
      input[type="number"]{ width:120px; }
      button{ padding:7px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:14px; cursor:pointer; transition: transform .05s ease, background .2s ease; }
      button:active{ transform: translateY(1px); }
      button.active{ background:#111; color:#fff; border-color:#111; }
      .card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:14px; }
      .grid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px; }
      table{ width:100%; border-collapse:collapse; }
      th, td{ text-align:left; padding:10px 12px; vertical-align: top; }
      thead th{ background:#f6f6f6; font-weight:600; font-size:13px; position:relative; }
      tbody tr{ border-top:1px solid var(--border); }
      .muted{ color:var(--muted); font-size:12px; }
      .nums{ font-variant-numeric: tabular-nums; }
      a.plink{ color:#0b57d0; text-decoration:none; }
      a.plink:hover{ text-decoration:underline; }
      dialog{ border:1px solid var(--border); border-radius:16px; padding:0; max-width:820px; width:95vw; }
      .modal-head{ padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:center; }
      .modal-body{ padding:12px 16px; max-height:72vh; overflow:auto; }
      .pill{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; color:#444; background:#fff; }
      .checkbox{ transform: translateY(2px); }
      .ok{ color:#0b7a0b; }
      .err{ color:#b00020; }

      /* Pretty multi-select */
      .multi{ position:relative; }
      .multi-btn{ display:flex; align-items:center; gap:8px; min-height:36px; border:1px solid var(--border); border-radius:10px; padding:6px 10px; background:#fff; width:100%; justify-content:space-between; }
      .multi-chips{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
      .multi-placeholder{ color:#888; }
      .multi-caret{ font-size:12px; color:#444; }
      .multi-menu{ position:absolute; top:100%; left:0; right:0; margin-top:6px; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:8px; z-index:20; }
      .multi-menu.hidden{ display:none; }
      .multi-search{ width:100%; margin-bottom:8px; }
      .multi-list{ max-height:220px; overflow:auto; border-top:1px solid var(--border); border-bottom:1px solid var(--border); padding:6px 0; }
      .multi-item{ display:flex; align-items:center; gap:8px; padding:6px 4px; cursor:pointer; }
      .multi-item:hover{ background:#f7f7f7; }
      .chip-x{ cursor:pointer; font-weight:600; font-size:12px; opacity:.7; }
      .chip-x:hover{ opacity:1; }
      .ring{ outline:3px solid var(--ring); outline-offset:2px; }

      @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
    </style>
  </head>
  <body>
    <header>
      <div class="container row">
        <div style="font-weight:600; font-size:18px">Printer Index</div>
        <div class="muted">rank researchers by output</div>
        <div class="spacer"></div>
        <!-- search removed -->
      </div>
    </header>

    <main class="container" style="padding:16px">
      <section class="grid">
        <!-- Scoring metric -->
        <div class="card">
          <div style="font-weight:600; font-size:14px">Scoring metric</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
            <button data-metric="papers" class="metricBtn active">papers</button>
            <button data-metric="pages" class="metricBtn">pages</button>
            <button data-metric="citations" class="metricBtn">citations</button>
            <button data-metric="weighted" class="metricBtn">weighted</button>
            <button data-metric="custom" class="metricBtn">custom</button>
          </div>
          <div id="weightedBox" style="display:none; margin-top:10px">
            <div class="row" style="gap:10px">
              <span class="muted">basis</span>
              <select id="basis">
                <option value="papers">papers</option>
                <option value="pages">pages</option>
                <option value="citations">citations</option>
              </select>
            </div>
            <div style="margin-top:8px">
              <label class="muted">half-life: <span id="hl_label">4</span> years</label>
              <input id="halflife" type="range" min="1" max="12" step="1" value="4" style="width:100%" />
              <div class="muted">score = Σ exp(-ln2·Δ/halfLife) × basis(year)</div>
            </div>
          </div>

          <!-- Custom formula -->
          <div id="customBox" style="display:none; margin-top:10px">
            <div class="muted" style="margin-bottom:6px">
              Variables: <code>papers</code>, <code>pages</code>, <code>citations</code>, <code>avg_pages</code>, <code>avg_citations</code>.
              Example: <code>citations / (papers || 1)</code> or <code>pages + 2*citations</code>.
            </div>
            <textarea id="customFormula" rows="3" style="width:100%">citations / (papers || 1)</textarea>
            <div class="row" style="margin-top:6px">
              <button id="applyCustom">Apply</button>
              <div id="customMsg" class="muted" style="margin-left:6px"></div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card">
          <div style="font-weight:600; font-size:14px">Filters</div>
          <!-- Pretty multi-select for conferences -->
          <div class="row" style="gap:8px; margin-top:6px">
            <div id="confMulti" class="multi" style="width:100%">
              <button id="confBtn" class="multi-btn" type="button" aria-haspopup="listbox" aria-expanded="false">
                <div id="confChips" class="multi-chips">
                  <span class="multi-placeholder">Any conference</span>
                </div>
                <span class="multi-caret">▾</span>
              </button>
              <div id="confMenu" class="multi-menu hidden">
                <input id="confSearch" class="multi-search" type="text" placeholder="Search conferences…" />
                <div id="confList" class="multi-list"></div>
              </div>
            </div>
          </div>
          <!-- years -->
          <div class="row" style="margin-top:10px; gap:10px">
            <div><span class="muted">years</span></div>
            <input id="from" type="number" />
            <span class="muted">to</span>
            <input id="to" type="number" />
          </div>
          <!-- page count range -->
          <div class="row" style="margin-top:10px; gap:10px">
            <div><span class="muted">page count</span></div>
            <input id="pageMin" type="number" placeholder="min" />
            <span class="muted">to</span>
            <input id="pageMax" type="number" placeholder="max" />
          </div>
          <!-- citations range -->
          <div class="row" style="margin-top:10px; gap:10px">
            <div><span class="muted">citations</span></div>
            <input id="citeMin" type="number" placeholder="min" />
            <span class="muted">to</span>
            <input id="citeMax" type="number" placeholder="max" />
          </div>
        </div>
      </section>

      <!-- Selected Group table -->
      <section id="selectedSection" class="card" style="margin-top:14px; display:none; overflow:auto">
        <div style="font-weight:600; margin-bottom:8px">Selected</div>
        <table>
          <thead>
          <tr>
            <th style="width:34px"></th>
            <th>#</th>
            <th>Printer</th>
            <th>Institution</th>
            <th>Score</th>
            <th>Totals</th>
            <th>Trend</th>
          </tr>
          </thead>
          <tbody id="rowsSelected"></tbody>
        </table>
      </section>

      <!-- Full table -->
      <section class="card" style="margin-top:14px; overflow:auto">
        <div style="position:relative">
          <table>
            <thead>
              <tr>
                <th style="width:34px"></th>
                <th style="width:50px">#</th>
                <th>Printer</th>
                <th>Institution</th>
                <th>Score</th>
                <th>Totals</th>
                <th>Trend</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>

      <p class="muted" style="margin:12px 4px 36px">
        Data source: Google Scholar–derived JSON; pages from PDFs when possible.
        Works with <code>preprint === "None"</code> are excluded from counts.
      </p>
    </main>

    <!-- Modal -->
    <dialog id="pubModal">
      <div class="modal-head">
        <div style="font-weight:600" id="modalTitle">Publications</div>
        <div class="spacer"></div>
        <button id="closeModal">Close</button>
      </div>
      <div class="modal-body" id="pubList"></div>
    </dialog>

    <script>
      const state = {
        metric:'papers', basis:'papers', halfLife:4,
        fromYear:2015, toYear:new Date().getFullYear(),
        pageMin:null, pageMax:null,
        citeMin:null, citeMax:null,
        conf:[], data:null,
        selected:new Set(),
        customFormula:'citations / (papers || 1)'
      };

      // ---------- helpers ----------
      function expDecayWeight(y,hl,cur){ if(!hl||hl<=0)return 1; const dt=Math.max(0,cur-y); return Math.exp(-Math.log(2)*dt/hl); }
      function workCitations(w){ return Number(w.citations??w.cited_by_count??w.cited_by??0)||0; }
      const numOrNull = v => {
        if (v === null || v === undefined) return null;
        if (typeof v === 'string' && v.trim() === '') return null; // empty => no constraint
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };

      function includeWork(w){
        if(!w||!w.year) return false;

        // Core inclusion rule for "counts toward number of papers"
        if((!w.preprint || String(w.preprint).toLowerCase()==='none') && (!w.pages || w.pages===0) && (!w.conference || String(w.conference).toLowerCase()==='other'))
          return false;

        if(w.year<state.fromYear || w.year>state.toYear) return false;

        // Conference filter (if any)
        if(state.conf && state.conf.length){
          const conf=(w.conference||'').toLowerCase();
          const wants=state.conf.map(c=>c.toLowerCase());
          const ok = wants.some(want =>
            (want==='preprint' && conf==='preprint') ||
            (want==='other' && conf==='other') ||
            conf.startsWith(want)
          );
          if(!ok) return false;
        }

        // Page-count filter
        const pages = Number(w.pages||0);
        if(state.pageMin!==null && pages < state.pageMin) return false;
        if(state.pageMax!==null && pages > state.pageMax) return false;

        // Citations filter
        const cites = workCitations(w);
        if(state.citeMin!==null && cites < state.citeMin) return false;
        if(state.citeMax!==null && cites > state.citeMax) return false;

        return true;
      }

      function seriesFor(p){
        const y=[],pp=[],pg=[],cc=[];
        for(let yr=state.fromYear; yr<=state.toYear; yr++){
          y.push(yr);
          const ws=(p.works||[]).filter(w=>includeWork(w)&&w.year===yr);
          pp.push(ws.length);
          pg.push(ws.reduce((a,w)=>a+(w.pages||0),0));
          cc.push(ws.reduce((a,w)=>a+workCitations(w),0));
        }
        return {years:y,papers:pp,pages:pg,citations:cc};
      }

      function totalsForSeries(s){
        const papers=s.papers.reduce((a,x)=>a+x,0);
        const pages=s.pages.reduce((a,x)=>a+x,0);
        const citations=s.citations.reduce((a,x)=>a+x,0);
        const avg_pages = pages / Math.max(1, papers);
        const avg_citations = citations / Math.max(1, papers);
        return {papers, pages, citations, avg_pages, avg_citations};
      }

      function scoreFromSeries(s){
        if(state.metric==='papers')    return s.papers.reduce((a,x)=>a+x,0);
        if(state.metric==='pages')     return s.pages.reduce((a,x)=>a+x,0);
        if(state.metric==='citations') return s.citations.reduce((a,x)=>a+x,0);
        if(state.metric==='weighted'){
          const arr=(state.basis==='papers')?s.papers:(state.basis==='pages')?s.pages:s.citations;
          return arr.reduce((a,v,i)=>a+v*expDecayWeight(s.years[i],state.halfLife,state.toYear),0);
        }
        const t = totalsForSeries(s);
        return evalCustom(t);
      }

      // ---------- custom formula ----------
      function evalCustom(vars){
        const formula = state.customFormula || 'citations';
        if(!/^[0-9+\-*/().,_ a-zA-Z<>!=&|?:%^\[\]]+$/.test(formula)){
          throw new Error('Unsupported characters in formula');
        }
        const scope = {
          papers:vars.papers, pages:vars.pages, citations:vars.citations,
          avg_pages:vars.avg_pages, avg_citations:vars.avg_citations, Math
        };
        try{
          const fn = new Function(...Object.keys(scope), `return (${formula});`);
          const val = fn(...Object.values(scope));
          return (Number.isFinite(val) ? Number(val) : 0);
        }catch(e){
          const msg=document.getElementById('customMsg');
          if(msg){ msg.className='muted err'; msg.textContent='Error: '+e.message; }
          return 0;
        }
      }

      // ---------- rendering ----------
      function render(){
        if(!state.data) return;
        const all = (state.data.printers||state.data.professors||[]);

        // Selected table (if any)
        const selected = all.filter(p => state.selected.has(keyFor(p)));
        const rowsSel = selected.map(p => rowData(p)).sort((a,b)=>b.score-a.score);
        const selSection = document.getElementById('selectedSection');
        const selBody = document.getElementById('rowsSelected');
        selBody.innerHTML = '';
        if(rowsSel.length){
          selSection.style.display = 'block';
          rowsSel.forEach((r,i)=> selBody.appendChild(rowEl(i+1, r)));
        }else{
          selSection.style.display = 'none';
        }

        // Main table
        const rowsAll = all.map(p => rowData(p)).sort((a,b)=>b.score-a.score);
        const tbody = document.getElementById('rows');
        tbody.innerHTML = '';
        rowsAll.forEach((r,i)=> tbody.appendChild(rowEl(i+1, r)));

        // Refresh conference chips
        renderConfChips();
      }

      function rowData(p){
        const s = seriesFor(p);
        const totals = totalsForSeries(s);
        const score = scoreFromSeries(s);
        return { p, s, ...totals, score };
      }

      function rowEl(rank, r){
        const tr=document.createElement('tr');
        const checked = state.selected.has(keyFor(r.p)) ? 'checked' : '';
        tr.innerHTML = `
          <td><input type="checkbox" class="checkbox" ${checked} /></td>
          <td class="muted">${rank}</td>
          <td>
            <div style="font-weight:600">
              <a href="#" class="plink nameLink">${esc(r.p.name)}</a>
            </div>
          </td>
          <td>${esc(r.p.institution||'')}</td>
          <td class="nums" style="font-weight:600">${fmt(r.score)}</td>
          <td class="nums">📄 ${r.papers}&nbsp;&nbsp;📚 ${r.pages}&nbsp;&nbsp;📈 ${r.citations}</td>
          <td>${sparkline(state.metric==='pages' ? r.s.pages : r.s.papers)}</td>
        `;
        tr.querySelector('.checkbox').addEventListener('change', (e) => {
          const k = keyFor(r.p);
          if(e.target.checked) state.selected.add(k); else state.selected.delete(k);
          render();
        });
        tr.querySelector('.nameLink').addEventListener('click',(e)=>{ e.preventDefault(); openModal(r.p); });
        tr.querySelector('.nameLink').addEventListener('dblclick',(e)=>{ e.preventDefault(); openModal(r.p); });
        return tr;
      }

      // ---------- small utils ----------
      function keyFor(p){ return p.scholar_user || `name::${(p.name||'').toLowerCase()}`; }
      const esc=s=> (s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      const fmt=x=>typeof x!=='number'?x:x>=1000&&state.metric!=='weighted'&&state.metric!=='custom'?x.toLocaleString():x.toFixed(2);
      function sparkline(v){const w=96,h=28,m=Math.max(1,...v);const pts=v.map((x,i)=>`${(i/Math.max(v.length-1,1))*(w-2)+1},${h-1-(x/m)*(h-4)}`).join(' ');return `<svg class="spark" width="${w}" height="${h}"><polyline fill="none" stroke="currentColor" stroke-width="2" points="${pts}"/></svg>`;}

      // ---------- modal (use same inclusion as counts) ----------
      function openModal(p){
        const dlg=document.getElementById('pubModal');
        document.getElementById('modalTitle').textContent=`${p.name} — publications`;
        const list=document.getElementById('pubList'); list.innerHTML='';

        // Only works that pass current filter *and* count toward totals
        const ws=(p.works||[]).filter(includeWork).sort((a,b)=>(b.year||0)-(a.year||0));
        if(!ws.length){
          list.innerHTML=`<div class="muted">No publications in current filters.</div>`;
        }else{
          ws.forEach(w=>{
            const lnk=esc(w.id||''),t=esc(w.title||'(untitled)'),y=w.year||'',pg=w.pages||0,conf=esc(w.conference||''),ven=esc(w.venue||''),cit=workCitations(w),pre=esc(w.preprint||'');
            const href=lnk?` href="${lnk}" target="_blank" rel="noopener"`:'';
            list.innerHTML+=`<div style="padding:10px 0;border-top:1px solid var(--border)">
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:baseline">
                <a class="plink"${href}>${t}</a>
                ${pre && pre.toLowerCase()!=='none' ? `<span class="pill">${pre}</span>` : ''}
                ${conf ? `<span class="pill">${conf}</span>` : ''}
              </div>
              <div class="muted">${y} · ${ven} · pages: ${pg} · citations: ${cit}</div>
            </div>`;
          });
        }
        dlg.showModal();
      }
      document.getElementById('closeModal').addEventListener('click',()=>document.getElementById('pubModal').close());
      document.getElementById('pubModal').addEventListener('click',(e)=>{ if(e.target===e.currentTarget) e.currentTarget.close(); });

      // ---------- metric UI ----------
      document.querySelectorAll('.metricBtn').forEach(b=>b.onclick=()=>{
        document.querySelectorAll('.metricBtn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        state.metric=b.dataset.metric;
        document.getElementById('weightedBox').style.display=(state.metric==='weighted')?'block':'none';
        document.getElementById('customBox').style.display=(state.metric==='custom')?'block':'none';
        render();
      });
      document.getElementById('basis').onchange=e=>{ state.basis=e.target.value; render(); };
      document.getElementById('halflife').oninput=e=>{ state.halfLife=+e.target.value; document.getElementById('hl_label').textContent=state.halfLife; render(); };

      // years
      document.getElementById('from').onchange=e=>{ state.fromYear=+e.target.value; render(); };
      document.getElementById('to').onchange=e=>{ state.toYear=+e.target.value; render(); };

      // page/citation ranges
      document.getElementById('pageMin').addEventListener('input', e => { state.pageMin = numOrNull(e.target.value); render(); });
      document.getElementById('pageMax').addEventListener('input', e => { state.pageMax = numOrNull(e.target.value); render(); });
      document.getElementById('citeMin').addEventListener('input', e => { state.citeMin = numOrNull(e.target.value); render(); });
      document.getElementById('citeMax').addEventListener('input', e => { state.citeMax = numOrNull(e.target.value); render(); });

      // ---------- Pretty conference multiselect (instant apply) ----------
      let confOpen = false, allConfsCache = [];
      function toggleConfMenu(show){
        const btn = document.getElementById('confBtn');
        const menu = document.getElementById('confMenu');
        confOpen = (show!==undefined)? show : !confOpen;
        btn.setAttribute('aria-expanded', confOpen ? 'true' : 'false');
        menu.classList.toggle('hidden', !confOpen);
        if(confOpen) document.getElementById('confSearch').focus();
      }
      document.getElementById('confBtn').onclick = () => toggleConfMenu();
      document.addEventListener('click', (e)=>{
        const wrap = document.getElementById('confMulti');
        if(confOpen && !wrap.contains(e.target)) toggleConfMenu(false);
      });

      function buildConfOptions(allLabels){
        const list = document.getElementById('confList');
        list.innerHTML = '';
        const q = document.getElementById('confSearch').value.trim().toLowerCase();
        const filtered = allLabels.filter(c => !q || c.toLowerCase().includes(q));
        if(!filtered.length){
          list.innerHTML = '<div class="muted" style="padding:6px 4px">No matches</div>';
          return;
        }
        filtered.forEach(label => {
          const row = document.createElement('div');
          row.className = 'multi-item';
          row.innerHTML = `<input type="checkbox" class="confChk" data-label="${label}"><span>${label}</span>`;
          const chk = row.querySelector('.confChk');
          chk.addEventListener('change', ev => {
            toggleLabel(label, ev.target.checked);
            render(); // instant
          });
          list.appendChild(row);
        });
        updateConfChecks();
      }
      function toggleLabel(label, checked){
        const i = state.conf.indexOf(label);
        if(checked && i<0) state.conf.push(label);
        if(!checked && i>=0) state.conf.splice(i,1);
        renderConfChips();
        updateConfChecks();
      }
      function updateConfChecks(){
        const chks = document.querySelectorAll('.confChk');
        chks.forEach(chk => { chk.checked = state.conf.includes(chk.dataset.label); });
      }
      function renderConfChips(){
        const box = document.getElementById('confChips');
        box.innerHTML = '';
        if(!state.conf.length){
          const span = document.createElement('span');
          span.className = 'multi-placeholder';
          span.textContent = 'Any conference';
          box.appendChild(span);
          return;
        }
        state.conf.forEach(label=>{
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.innerHTML = `${label} <span class="chip-x" title="remove">×</span>`;
          chip.querySelector('.chip-x').onclick = (e)=>{ e.stopPropagation(); toggleLabel(label,false); render(); };
          box.appendChild(chip);
        });
      }
      document.getElementById('confSearch').addEventListener('input', ()=>{ buildConfOptions(allConfsCache); });

      // ---------- data boot ----------
      async function loadData(){
        const r=await fetch('./data.json?ts='+Date.now());
        if(!r.ok) throw new Error('HTTP '+r.status);
        state.data=await r.json();
        setupFilters();
        render();
      }
      function setupFilters(){
        const data = state.data;
        const years = (data.years && data.years.length) ? data.years : inferYears(data);
        state.fromYear = years[0]; state.toYear = years[years.length-1];
        document.getElementById('from').value = state.fromYear;
        document.getElementById('to').value = state.toYear;

        const confs = new Set(['preprint','Other']);
        (data.printers || data.professors || []).forEach(p => (p.works||[]).forEach(w=>{
          if(w.conference){
            const label = String(w.conference).split(/\s+\d{4}\b/)[0];
            if(label) confs.add(label);
          }
        }));
        allConfsCache = Array.from(confs).sort((a, b) => {
          const A = a.toLowerCase(), B = b.toLowerCase();
          if (A === "other") return 1;
          if (B === "other") return -1;
          return A.localeCompare(B);
        });
        buildConfOptions(allConfsCache);
        renderConfChips();
      }
      function inferYears(d){
        const ys=new Set();
        (d.printers||d.professors||[]).forEach(p => (p.works||[]).forEach(w => { if(w.year) ys.add(w.year); }));
        return [...ys].sort((a,b)=>a-b);
      }

      loadData();
    </script>
  </body>
</html>
